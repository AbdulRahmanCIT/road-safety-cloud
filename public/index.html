<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Road Hazard Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>

<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>

body{
margin:0;
font-family:Inter, sans-serif;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}

#loginPage{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:linear-gradient(135deg,#020617,#0f172a);
}

.login-box{
background:#020617;
padding:40px;
border-radius:18px;
width:320px;
box-shadow:0 0 40px #2563eb55;
text-align:center;
}

.login-box input{
width:100%;
padding:12px;
margin:10px 0;
border:none;
border-radius:8px;
background:#0f172a;
color:white;
}

.login-box button{
width:100%;
padding:12px;
border:none;
border-radius:8px;
background:linear-gradient(90deg,#2563eb,#22c55e);
color:white;
font-weight:600;
cursor:pointer;
}

#dashboard{display:none;padding:20px;}

.cards{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:20px;
margin-bottom:20px;
}

.card{
background:#020617;
padding:18px;
border-radius:14px;
}

.value{font-size:26px;font-weight:700;}

#map{
height:380px;
border-radius:14px;
margin-bottom:20px;
}

table{
width:100%;
border-collapse:collapse;
background:#020617;
border-radius:14px;
overflow:hidden;
}

th,td{
padding:12px;
border-bottom:1px solid #1e293b;
}

th{background:#0f172a;}

</style>
</head>

<body>

<!-- LOGIN -->

<div id="loginPage">
<div class="login-box">
<h2>Admin Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>
</div>

<!-- DASHBOARD -->

<div id="dashboard">

<h1>Road Hazard Intelligence</h1>

<div class="cards">
<div class="card">Total Hazards<div id="total" class="value">0</div></div>
<div class="card">High Severity<div id="high" class="value">0</div></div>
<div class="card">Moderate<div id="mod" class="value">0</div></div>
<div class="card">Resolved<div id="res" class="value">0</div></div>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Type</th>
<th>Location</th>
<th>Vehicles</th>
<th>Shock</th>
<th>Severity</th>
<th>Status</th>
<th>Date</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>

/* LOGIN */

function login(){

if(username.value==="admin" && password.value==="1234"){
loginPage.style.display="none";
dashboard.style.display="block";
initMap();
loadData();
setInterval(loadData,5000);
}
else alert("Invalid Login");
}

/* MAP */

let map,cluster,heatLayer;

function initMap(){

map=L.map('map').setView([20.5937,78.9629],5);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
).addTo(map);

cluster=L.markerClusterGroup();
map.addLayer(cluster);
}

/* FETCH + DASHBOARD */

async function loadData(){

try{

const res = await fetch("/api/road-events");
let data = await res.json();

/* SORT LATEST */

data = data.sort(
(a,b)=>new Date(b.created_at)-new Date(a.created_at)
);

/* KPI */

total.innerText = data.length;
high.innerText = data.filter(x=>x.severity==="High").length;
mod.innerText = data.filter(x=>x.severity==="Moderate").length;
res.innerText = data.filter(x=>x.status==="Resolved").length;

/* TABLE + MAP */

tbody.innerHTML="";
cluster.clearLayers();

const heat=[];

/* TOP 10 + SEQUENCE ID */

data.slice(0,10).forEach((d,index)=>{

/* MAP ONLY VALID GPS */

if(
d.latitude &&
d.longitude &&
d.latitude!=0 &&
d.longitude!=0
){

const marker = L.marker([d.latitude,d.longitude])
.bindPopup(`<b>${d.event_type}</b><br>${d.location}`);

cluster.addLayer(marker);

heat.push([d.latitude,d.longitude,0.7]);
}

/* TABLE */

tbody.innerHTML += `
<tr>
<td>${index+1}</td>
<td>${d.event_type}</td>
<td>${d.location}</td>
<td>${d.vehicle_count || 1}</td>
<td>${d.accel_z}</td>
<td>${d.severity}</td>
<td>${d.status}</td>
<td>${new Date(d.created_at).toLocaleString()}</td>
</tr>`;
});

/* HEATMAP */

if(heatLayer) map.removeLayer(heatLayer);

heatLayer = L.heatLayer(heat,{
radius:25,
blur:15
}).addTo(map);

}
catch(err){
console.error("Fetch error:",err);
}

}

</script>
</body>
</html>
