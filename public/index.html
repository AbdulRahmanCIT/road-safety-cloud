<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Road Hazard Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body{
margin:0;
font-family:Inter, sans-serif;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:
radial-gradient(circle at 20% 20%,#2563eb55,transparent),
radial-gradient(circle at 80% 70%,#22c55e55,transparent),
linear-gradient(135deg,#020617,#0f172a);
}

.login-box{
background:#020617dd;
padding:40px;
border-radius:18px;
width:320px;
box-shadow:0 0 40px #2563eb55;
text-align:center;
}

.login-box input{
width:100%;
padding:12px;
margin:10px 0;
border:none;
border-radius:8px;
background:#0f172a;
color:white;
}

.login-box button{
width:100%;
padding:12px;
border:none;
border-radius:8px;
background:linear-gradient(90deg,#2563eb,#22c55e);
color:white;
font-weight:600;
cursor:pointer;
}

/* DASHBOARD */
#dashboard{display:none;padding:20px;}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.title{font-size:34px;font-weight:700;}

.cards{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:20px;
margin-bottom:20px;
}

.card{background:#020617;padding:18px;border-radius:14px;}
.value{font-size:26px;font-weight:700;}

.chart-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
margin-bottom:20px;
}

.chart-box{
background:#020617;
border-radius:14px;
height:260px;
display:flex;
align-items:center;
justify-content:center;
}

#map{height:340px;border-radius:14px;margin-bottom:20px;}

table{
width:100%;
border-collapse:collapse;
background:#020617;
border-radius:14px;
overflow:hidden;
}

th,td{padding:12px;border-bottom:1px solid #1e293b;}
th{background:#0f172a;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="login-box">
<h2>IoT Admin Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="header">
<div class="title">Road Hazard Intelligence</div>
</div>

<div class="cards">
<div class="card">Total Hazards<div class="value" id="total">0</div></div>
<div class="card">High Severity<div class="value" id="high">0</div></div>
<div class="card">Moderate<div class="value" id="mod">0</div></div>
<div class="card">Resolved<div class="value" id="res">0</div></div>
</div>

<div class="chart-grid">
<div class="chart-box"><canvas id="sevChart"></canvas></div>
<div class="chart-box"><canvas id="typeChart"></canvas></div>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Type</th>
<th>Location</th>
<th>Vehicles</th>
<th>Shock Value</th>
<th>Severity</th>
<th>Status</th>
<th>Date & Time</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>

/* LOGIN */
function login(){
if(username.value==="admin" && password.value==="1234"){
loginPage.style.display="none";
dashboard.style.display="block";
initMap();
loadData();
setInterval(loadData,5000);
}else alert("Invalid Login");
}

/* MAP INIT */

let map,cluster,heatLayer;
let sevChartObj,typeChartObj;

function initMap(){
map=L.map('map').setView([20.5937,78.9629],5);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
).addTo(map);

cluster=L.markerClusterGroup();
map.addLayer(cluster);
}

/* ================= FETCH BLOCK (FIXED) ================= */

async function loadData(){

const res = await fetch(
"https://road-hazard-monitor.onrender.com/api/dashboard"
);

const result = await res.json();

/* SPLIT DATA */

let data = result.table;        // KPI + Table
let mapData = result.mapPoints; // Map

/* KPI UPDATE */

total.innerText = data.length;

high.innerText =
data.filter(d=>d.severity==="High").length;

mod.innerText =
data.filter(d=>d.severity==="Moderate").length;

res.innerText =
data.filter(d=>d.status==="Resolved").length;

/* MAP UPDATE (ALL LOCATIONS) */

cluster.clearLayers();

const heat=[];

mapData.forEach(d=>{

if(d.latitude && d.longitude){

const marker=L.marker([d.latitude,d.longitude])
.bindPopup(`<b>${d.event_type}</b><br>${d.location}`);

cluster.addLayer(marker);
heat.push([d.latitude,d.longitude,0.6]);

}

});

if(heatLayer) map.removeLayer(heatLayer);
heatLayer=L.heatLayer(heat,{radius:25}).addTo(map);

/* TABLE UPDATE (LATEST 10) */

tbody.innerHTML="";

data
.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
.slice(0,10)
.forEach((d,i)=>{

tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${d.event_type}</td>
<td>${d.location}</td>
<td>${d.vehicle_count}</td>
<td>${d.accel_z}</td>
<td>${d.severity}</td>
<td>${d.status}</td>
<td>${new Date(d.created_at).toLocaleString()}</td>
</tr>`;
});

/* CHARTS */

const sev={High:0,Moderate:0,Low:0};
const type={Pothole:0,"Speed Breaker":0};

data.forEach(d=>{
if(sev[d.severity]!=undefined) sev[d.severity]++;
if(type[d.event_type]!=undefined) type[d.event_type]++;
});

if(sevChartObj) sevChartObj.destroy();
if(typeChartObj) typeChartObj.destroy();

sevChartObj=new Chart(sevChart,{
type:"doughnut",
data:{labels:Object.keys(sev),
datasets:[{data:Object.values(sev)}]},
options:{cutout:"65%"}
});

typeChartObj=new Chart(typeChart,{
type:"bar",
data:{
labels:["Pothole","Speed Breaker"],
datasets:[{data:[
type["Pothole"],
type["Speed Breaker"]
]}]
}
});

}

</script>
</body>
</html>
