<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Road Hazard Intelligence</title>

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Leaflet -->
<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
body{
margin:0;
font-family:Inter,sans-serif;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:linear-gradient(135deg,#020617,#0f172a);
}

.login-box{
background:#020617;
padding:40px;
border-radius:18px;
width:300px;
text-align:center;
}

.login-box input{
width:100%;
padding:12px;
margin:10px 0;
border:none;
border-radius:8px;
background:#0f172a;
color:white;
}

.login-box button{
width:100%;
padding:12px;
border:none;
border-radius:8px;
background:#2563eb;
color:white;
cursor:pointer;
}

/* DASHBOARD */
#dashboard{display:none;padding:20px;}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.title{font-size:30px;font-weight:700;}

.btn{
padding:8px 16px;
border:none;
border-radius:8px;
color:white;
cursor:pointer;
margin-left:8px;
}

.refresh{background:#2563eb;}
.logout{background:#ef4444;}

.cards{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:20px;
margin-bottom:20px;
}

.card{
background:#020617;
padding:18px;
border-radius:14px;
}

.value{
font-size:26px;
font-weight:700;
}

/* Charts */
.chart-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
margin-bottom:20px;
}

.chart-box{
background:#020617;
border-radius:14px;
height:260px;
display:flex;
align-items:center;
justify-content:center;
}

/* Map */
#map{
height:340px;
border-radius:14px;
margin-bottom:20px;
}

/* Table */
table{
width:100%;
border-collapse:collapse;
background:#020617;
border-radius:14px;
overflow:hidden;
}

th,td{
padding:12px;
border-bottom:1px solid #1e293b;
}

th{background:#0f172a;}
tr:hover{background:#111827;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="login-box">
<h2>Admin Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="header">
<div class="title">Road Hazard Intelligence</div>
<div>
<button class="btn refresh" onclick="loadData()">Refresh</button>
<button class="btn logout" onclick="logout()">Logout</button>
</div>
</div>

<!-- KPI -->
<div class="cards">
<div class="card">Total Hazards<div class="value" id="total">0</div></div>
<div class="card">High Severity<div class="value" id="high">0</div></div>
<div class="card">Moderate<div class="value" id="mod">0</div></div>
<div class="card">Resolved<div class="value" id="res">0</div></div>
</div>

<!-- Charts -->
<div class="chart-grid">
<div class="chart-box"><canvas id="sevChart"></canvas></div>
<div class="chart-box"><canvas id="typeChart"></canvas></div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Table -->
<table>
<thead>
<tr>
<th>ID</th>
<th>Type</th>
<th>Location</th>
<th>Vehicles</th>
<th>Shock</th>
<th>Severity</th>
<th>Status</th>
<th>Date</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>

/* LOGIN */
function login(){
if(username.value==="admin" && password.value==="1234"){
loginPage.style.display="none";
dashboard.style.display="block";
initMap();
loadData();
setInterval(loadData,5000);
}else alert("Invalid Login");
}

function logout(){location.reload();}

/* MAP */
let map,cluster;
function initMap(){
map=L.map('map').setView([20.5937,78.9629],5);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
).addTo(map);

cluster=L.markerClusterGroup();
map.addLayer(cluster);
}

/* LOAD DATA */
async function loadData(){

const res=await fetch(
"https://road-hazard-monitor.onrender.com/api/road-events"
);

const data=await res.json();

/* KPI */
total.innerText=data.length;
high.innerText=data.filter(d=>d.severity==="High").length;
mod.innerText=data.filter(d=>d.severity==="Moderate").length;
res.innerText=data.filter(d=>d.status==="Resolved").length;

/* TABLE + MAP */
tbody.innerHTML="";
cluster.clearLayers();

data
.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
.slice(0,10)
.forEach((d,i)=>{

/* GPS FIX */
if(
d.latitude &&
d.longitude &&
d.latitude!=0 &&
d.longitude!=0
){
const marker=L.marker([d.latitude,d.longitude])
.bindPopup(`<b>${d.event_type}</b><br>${d.location}`);

cluster.addLayer(marker);
}

tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${d.event_type}</td>
<td>${d.location}</td>
<td>${d.vehicle_count||1}</td>
<td>${d.accel_z}</td>
<td>${d.severity}</td>
<td>${d.status}</td>
<td>${new Date(d.created_at).toLocaleString()}</td>
</tr>`;
});

/* CHARTS */
const sev={High:0,Moderate:0,Low:0};
const type={POTHOLE:0,SPEED_BREAKER:0};

data.forEach(d=>{
if(sev[d.severity]!=undefined) sev[d.severity]++;
if(type[d.event_type]!=undefined) type[d.event_type]++;
});

new Chart(sevChart,{
type:"doughnut",
data:{labels:Object.keys(sev),
datasets:[{data:Object.values(sev)}]}
});

new Chart(typeChart,{
type:"bar",
data:{
labels:["Pothole","Speed Breaker"],
datasets:[{
data:[
type.POTHOLE,
type.SPEED_BREAKER
]
}]
}
});

}

</script>
</body>
</html>
