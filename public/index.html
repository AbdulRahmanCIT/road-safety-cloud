<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Road Hazard Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body{
margin:0;
font-family:Inter, sans-serif;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
}

/* LOGIN */
#loginPage{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:
radial-gradient(circle at 20% 20%,#2563eb55,transparent),
radial-gradient(circle at 80% 70%,#22c55e55,transparent),
linear-gradient(135deg,#020617,#0f172a);
}

.login-box{
background:#020617dd;
padding:40px;
border-radius:18px;
width:320px;
box-shadow:0 0 40px #2563eb55;
text-align:center;
}

.login-box input{
width:100%;
padding:12px;
margin:10px 0;
border:none;
border-radius:8px;
background:#0f172a;
color:white;
}

.login-box button{
width:100%;
padding:12px;
border:none;
border-radius:8px;
background:linear-gradient(90deg,#2563eb,#22c55e);
color:white;
font-weight:600;
cursor:pointer;
}

/* DASHBOARD */
#dashboard{display:none;padding:20px;}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.title{font-size:34px;font-weight:700;}

.btn-group{display:flex;gap:10px;}

.btn{
padding:8px 18px;
border:none;
border-radius:8px;
color:white;
font-weight:600;
cursor:pointer;
}

.refresh{background:linear-gradient(90deg,#2563eb,#22c55e);}
.logout{background:linear-gradient(90deg,#ef4444,#f97316);}

.cards{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:20px;
margin-bottom:20px;
}

.card{background:#020617;padding:18px;border-radius:14px;}
.value{font-size:26px;font-weight:700;}

.chart-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
margin-bottom:20px;
}

.chart-box{
background:#020617;
border-radius:14px;
height:260px;
display:flex;
align-items:center;
justify-content:center;
}

#map{height:340px;border-radius:14px;margin-bottom:20px;}

table{
width:100%;
border-collapse:collapse;
background:#020617;
border-radius:14px;
overflow:hidden;
}

th,td{padding:12px;border-bottom:1px solid #1e293b;}
th{background:#0f172a;}
tr:hover{background:#111827;cursor:pointer;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
<div class="login-box">
<h2>IoT Admin Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="header">
<div class="title">ðŸš§ Road Hazard Intelligence</div>

<div class="btn-group">
<button class="btn refresh" onclick="loadData()">Refresh</button>
<button class="btn logout" onclick="logout()">Logout</button>
</div>
</div>

<div class="cards">
<div class="card">Total Hazards<div class="value" id="total">0</div></div>
<div class="card">High Severity<div class="value" id="high">0</div></div>
<div class="card">Moderate<div class="value" id="mod">0</div></div>
<div class="card">Resolved<div class="value" id="res">0</div></div>
</div>

<div class="chart-grid">
<div class="chart-box"><canvas id="sevChart"></canvas></div>
<div class="chart-box"><canvas id="typeChart"></canvas></div>
</div>

<div id="map"></div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Type</th>
<th>Location</th>
<th>Vehicles</th>
<th>Shock Value</th>
<th>Severity</th>
<th>Status</th>
<th>Date & Time</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>

/* LOGIN FIX */
function login(){

const user=document.getElementById("username").value;
const pass=document.getElementById("password").value;

if(user==="admin" && pass==="1234"){

document.getElementById("loginPage").style.display="none";
document.getElementById("dashboard").style.display="block";

initMap();
loadData();

}
else{
alert("Invalid Login");
}
}

function logout(){location.reload();}

/* MAP */
let map,cluster,heatLayer;
let markersById={};

function initMap(){

map=L.map('map',{attributionControl:false})
.setView([20.5937,78.9629],5);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
).addTo(map);

cluster=L.markerClusterGroup();
map.addLayer(cluster);

/* Bengaluru Marker */
L.marker([12.9716,77.5946])
.addTo(map)
.bindPopup("Bengaluru HQ");

setTimeout(()=>map.invalidateSize(),500);
}

/* LOAD DATA */
async function loadData(){

const res=await fetch(
"https://road-hazard-monitor.onrender.com/api/road-events"
);

const data=await res.json();

/* KPI */
total.innerText=data.length;
high.innerText=data.filter(d=>d.severity==="High").length;
mod.innerText=data.filter(d=>d.severity==="Moderate").length;
res.innerText=data.filter(d=>d.status==="Resolved").length;

/* CLEAR */
tbody.innerHTML="";
cluster.clearLayers();
markersById={};

if(heatLayer) map.removeLayer(heatLayer);

const heat=[];

/* TABLE + MAP */
data.slice(0,10).forEach(d=>{

if(d.latitude && d.longitude){

const marker=L.marker(
[d.latitude,d.longitude]
).bindPopup(`<b>${d.event_type}</b><br>${d.location}`);

cluster.addLayer(marker);
markersById[d.id]=marker;

heat.push([d.latitude,d.longitude,0.6]);
}

const row=document.createElement("tr");

row.innerHTML=`
<td>${d.id}</td>
<td>${d.event_type}</td>
<td>${d.location}</td>
<td>${d.vehicle_count}</td>
<td>${d.accel_z}</td>
<td>${d.severity}</td>
<td>${d.status}</td>
<td>${new Date(d.created_at).toLocaleString()}</td>
`;

row.onclick=()=>{
const m=markersById[d.id];
if(m){
map.setView(m.getLatLng(),16);
m.openPopup();
}
};

tbody.appendChild(row);

});

/* HEATMAP */
heatLayer=L.heatLayer(heat,{radius:25}).addTo(map);

/* CHARTS */
const sev={High:0,Moderate:0,Low:0};
const type={Pothole:0,"Speed Breaker":0};

data.forEach(d=>{
if(sev[d.severity]!=undefined) sev[d.severity]++;
if(type[d.event_type]!=undefined) type[d.event_type]++;
});

new Chart(sevChart,{
type:"doughnut",
data:{labels:Object.keys(sev),
datasets:[{data:Object.values(sev)}]},
options:{cutout:"65%"}
});

new Chart(typeChart,{
type:"bar",
data:{
labels:["Pothole","Speed Breaker"],
datasets:[{data:[
type["Pothole"],
type["Speed Breaker"]
]}]
}
});

}

</script>
</body>
</html>
